<div *ngIf="user" class="profile-container">
  <!-- Section commune √† tous les r√¥les -->
  <mat-card>
    <mat-card-title>Mon profil</mat-card-title>
    <mat-card-actions align="end">
      <button mat-stroked-button color="primary" (click)="toggleEdit()">
        {{ editMode ? '‚ùå Annuler' : '‚úèÔ∏è Modifier le profil' }}
      </button>
    </mat-card-actions>

    <!-- Affichage du profil (lecture seule) -->
    <mat-card-content *ngIf="!editMode">

      <p *ngIf="user.nom"><strong>Nom :</strong> {{ user.nom }}</p>
      <p *ngIf="user.prenom"><strong>Pr√©nom :</strong> {{ user.prenom }}</p>
      <p *ngIf="user.telephone"><strong>T√©l :</strong> {{ user.telephone }}</p>
      <p *ngIf="user.emailContact"><strong>Email :</strong> {{ user.emailContact }}</p>
      <p *ngIf="user.email"><strong>Email :</strong> {{ user.email }}</p>
      <p *ngIf="user.poste"><strong>Poste:</strong> {{ user.poste }}</p>
      <p *ngIf="user.dateNaissance"><strong>Naissance :</strong> {{ user.dateNaissance | date }}</p>
      <p *ngIf="user.adresse"><strong>Adresse :</strong> {{ user.adresse }}</p>
      <p *ngIf="user.niveauEtude"><strong>Niveau d'√©tude :</strong> {{ user.niveauEtude }}</p>
      <p *ngIf="user.niveau && !isCandidat"><strong>Niveau :</strong> {{ user.niveau }}</p>
    </mat-card-content>


    <!-- Formulaire de modification dynamique -->
    <form *ngIf="editMode" [formGroup]="editForm" (ngSubmit)="submitProfileUpdate()">
      <mat-form-field appearance="fill">
        <mat-label>Nom</mat-label>
        <input matInput formControlName="nom" />
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Pr√©nom</mat-label>
        <input matInput formControlName="prenom" />
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Email</mat-label>
        <input matInput [disabled]="true" formControlName="email" />
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('telephone')">
        <mat-label>T√©l√©phone</mat-label>
        <input matInput formControlName="telephone" />
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('poste')">
        <mat-label>Poste</mat-label>
        <input matInput formControlName="poste" />
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('dateNaissance')">
        <mat-label>Date de naissance</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="dateNaissance" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('adresse')">
        <mat-label>Adresse</mat-label>
        <input matInput formControlName="adresse" />
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('niveauEtude')">
        <mat-label>Niveau d'√©tude</mat-label>
        <input matInput formControlName="niveauEtude" />
      </mat-form-field>

      <mat-form-field appearance="fill" *ngIf="editForm.get('niveau') && !isCandidat">
        <mat-label>Niveau</mat-label>
        <input matInput formControlName="niveau" />
      </mat-form-field>


      <div class="mt-3">
        <button mat-raised-button color="primary" type="submit" [disabled]="editForm.invalid">
          üíæ Enregistrer
        </button>
        <button mat-button type="button" (click)="cancelEdit()">‚ùå Annuler</button>
      </div>
    </form>
  </mat-card>

  <!-- Section sp√©cifique au CANDIDAT -->
  <div *ngIf="isCandidat">
    <h3>Mon parcours</h3>

    <!-- CVs -->
    <mat-expansion-panel *ngIf="user.cvs?.length">
      <mat-expansion-panel-header>
        <mat-panel-title>üìÑ CV</mat-panel-title>
      </mat-expansion-panel-header>

      <mat-list>
        <mat-list-item *ngFor="let cv of user.cvs">
          <!-- Lien vers le CV -->
          <a [href]="cv.fichierUrl" target="_blank" rel="noopener">
            {{ cv.titre }} - D√©pos√© le {{ cv.dateDepot | date:'shortDate' }}
          </a>

          <!-- Bouton remplacer -->
          <button mat-icon-button (click)="onReplaceCvClick(cv.id!)" style="margin-left:auto">
            <mat-icon>upload</mat-icon>
          </button>

          <!-- Champ fichier (visible seulement si cliqu√©) -->
          <input *ngIf="replaceCvId === cv.id" type="file" (change)="onCvFileSelected($event, cv.id!)"
            style="margin-top: 0.5rem;" />
        </mat-list-item>
      </mat-list>
    </mat-expansion-panel>



    <!-- Lettres de motivation -->
    <mat-expansion-panel *ngIf="user.lettres?.length">
      <mat-expansion-panel-header>
        <mat-panel-title>‚úâÔ∏è Lettres de motivation</mat-panel-title>
      </mat-expansion-panel-header>
      <mat-list>
        <mat-list-item *ngFor="let lettre of user.lettres">
          <a [href]="lettre.fichierUrl" target="_blank" rel="noopener">
            {{ lettre.titre }} - D√©pos√©e le {{ lettre.dateDepot | date:'shortDate' }}
          </a>

          <!-- üëá Bouton remplacer -->
          <button mat-icon-button (click)="onReplaceLettreClick(lettre.id!)" style="margin-left:auto">
            <mat-icon>upload</mat-icon>
          </button>

          <!-- üëá Input file -->
          <input *ngIf="replaceLettreId === lettre.id" type="file"
            (change)="onLettreFileSelected($event, lettre.id!)" />
        </mat-list-item>
      </mat-list>
    </mat-expansion-panel>

    <!-- üõ†Ô∏è Comp√©tences Techniques -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>üõ†Ô∏è Comp√©tences Techniques</mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Liste des comp√©tences existantes -->
      <mat-list *ngIf="user?.competences?.length">
        <mat-list-item *ngFor="let c of user.competences">
          <strong>{{ c.libelle }}</strong> ‚Äî {{ c.niveau }}
        </mat-list-item>
      </mat-list>

      <p *ngIf="!user?.competences?.length" class="text-muted">
        Aucune comp√©tence enregistr√©e pour le moment.
      </p>

      <hr />

      <!-- ‚ûï Formulaire d‚Äôajout -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>‚ûï Ajouter une comp√©tence technique</mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="addCompetenceForm" (ngSubmit)="addCompetence()">
          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Libell√©</mat-label>
            <input matInput formControlName="libelle" placeholder="Ex : Java, Angular, SQL..." />
            <mat-error *ngIf="addCompetenceForm.get('libelle')?.hasError('required')">
              Le libell√© est obligatoire.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Niveau</mat-label>
            <mat-select formControlName="niveau">
              <mat-option *ngFor="let n of niveaux" [value]="n">{{ n }}</mat-option>
            </mat-select>
          </mat-form-field>

          <div style="text-align: right; margin-top: 1rem;">
            <button mat-raised-button color="primary" type="submit" [disabled]="addCompetenceForm.invalid || loading">
              ‚ûï Ajouter
            </button>
          </div>
        </form>
      </mat-expansion-panel>
    </mat-expansion-panel>


    <!-- üó£Ô∏è Comp√©tences linguistiques -->
    <mat-expansion-panel *ngIf="user.competenceLinguistiques?.length">
      <mat-expansion-panel-header>
        <mat-panel-title>üó£Ô∏è Comp√©tences linguistiques</mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Bouton d'√©dition -->
      <div style="text-align: right; margin-bottom: 1rem;">
        <button mat-stroked-button color="primary" (click)="editLinguistique = !editLinguistique">
          {{ editLinguistique ? '‚ùå Annuler' : '‚úèÔ∏è Modifier' }}
        </button>
      </div>

      <!-- Formulaire d'√©dition -->
      <form *ngIf="editLinguistique">
        <div class="langue-container" *ngFor="let cl of user.competenceLinguistiques">
          <label class="langue-label">{{ cl.langue || 'Langue non sp√©cifi√©e' }}</label>
          <mat-form-field appearance="fill" class="niveau-field">
            <mat-label>Niveau</mat-label>
            <mat-select [(value)]="cl.niveau">
              <mat-option value="DEBUTANT">D√©butant</mat-option>
              <mat-option value="INTERMEDIAIRE">Interm√©diaire</mat-option>
              <mat-option value="EXPERT">Expert</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Boutons d'action -->
        <div style="margin-top: 1rem; text-align: right;">
          <button mat-raised-button color="primary" type="button" (click)="saveLangueUpdates()">
            üíæ Enregistrer
          </button>
          <button mat-button type="button" (click)="cancelLangueEdit()">‚ùå Annuler</button>
        </div>
      </form>

      <!-- Lecture seule -->
      <mat-list *ngIf="!editLinguistique">
        <mat-list-item *ngFor="let cl of user.competenceLinguistiques">
          <strong>{{ cl.langue || 'Langue non sp√©cifi√©e' }}</strong> ‚Äî {{ cl.niveau }}
        </mat-list-item>
      </mat-list>
    </mat-expansion-panel>



    <!-- Exp√©riences -->
    <mat-expansion-panel *ngIf="user.experiences?.length">
      <mat-expansion-panel-header>
        <mat-panel-title>üíº Exp√©riences</mat-panel-title>
      </mat-expansion-panel-header>
      <mat-list>
        <mat-list-item *ngFor="let exp of user.experiences" class="experience-item">
          <div class="experience-content">
            <strong>{{ exp.poste }}</strong> &#64; <strong>{{ exp.entreprise }}</strong>
            <div class="text-sm text-gray-500">
              <span *ngIf="exp.dateDebut">{{ exp.dateDebut | date: 'MMM yyyy' }}</span>
              -
              <span *ngIf="exp.dateFin; else enCours">{{ exp.dateFin | date: 'MMM yyyy' }}</span>
              <ng-template #enCours><em>Pr√©sent</em></ng-template>
            </div>
            <div *ngIf="exp.description" class="description mt-1" style="margin-top: 4px; color: #555;">
              {{ exp.description }}
            </div>
          </div>
        </mat-list-item>
      </mat-list>
      <!-- ‚ûï Ajouter une exp√©rience -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>‚ûï Ajouter une exp√©rience</mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="addExperienceForm" (ngSubmit)="addExperience()">
          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Poste</mat-label>
            <input matInput formControlName="poste" required />
          </mat-form-field>

          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Entreprise</mat-label>
            <input matInput formControlName="entreprise" required />
          </mat-form-field>

          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Date de d√©but</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="dateDebut" />
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Date de fin</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="dateFin" />
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="fill" style="width: 100%;">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description"></textarea>
          </mat-form-field>

          <div style="text-align: right; margin-top: 1rem;">
            <button mat-raised-button color="primary" type="submit" [disabled]="addExperienceForm.invalid || loading">
              ‚ûï Ajouter
            </button>
          </div>
        </form>
      </mat-expansion-panel>

    </mat-expansion-panel>

    <!-- M√©tadonn√©es RH -->
    <mat-expansion-panel *ngIf="user.metadonneeRH">
      <mat-expansion-panel-header>
        <mat-panel-title>üìä M√©tadonn√©es RH</mat-panel-title>
      </mat-expansion-panel-header>
      <div style="text-align: right; margin-top: 8px;  margin-bottom: 8px;">
        <button mat-stroked-button color="primary" (click)="toggleEditMetadonneeRh()">
          ‚úèÔ∏è Modifier
        </button>
      </div>
      <div *ngIf="!editMetadonneeRh">
        <mat-list>
          <mat-list-item><strong>Domaine :</strong> {{ user.metadonneeRH.domaineRecherche }}</mat-list-item>
          <mat-list-item><strong>Type contrat :</strong> {{ user.metadonneeRH.typeContrat }}</mat-list-item>
          <mat-list-item><strong>Localisation :</strong> {{ user.metadonneeRH.localisation }}</mat-list-item>
          <mat-list-item><strong>Disponibilit√© :</strong> {{ user.metadonneeRH.disponibilite }}</mat-list-item>
          <mat-list-item><strong>Pr√©tentions Salariales :</strong> {{ user.metadonneeRH.pretentionsSalariales
            }}</mat-list-item>
          <mat-list-item><strong>Source :</strong> {{ user.metadonneeRH.source }}</mat-list-item>
        </mat-list>


      </div>

      <!-- üìù Formulaire √©dition -->
      <form *ngIf="editMetadonneeRh" [formGroup]="editMetadonneeRhForm" (ngSubmit)="onSubmitMetadonneeRh()">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Domaine de recherche</mat-label>
          <mat-select formControlName="domaineRecherche">
            <mat-option value="IT">Informatique (IT)</mat-option>
            <mat-option value="BANQUE">Banque</mat-option>
            <mat-option value="FINANCE">Finance</mat-option>
            <mat-option value="MARKETING">Marketing</mat-option>
            <mat-option value="AUTRE">Autre</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Type de contrat</mat-label>
          <mat-select formControlName="typeContrat">
            <mat-option value="CDI">CDI</mat-option>
            <mat-option value="CDD">CDD</mat-option>
            <mat-option value="ALTERNANCE">Alternance</mat-option>
            <mat-option value="STAGE">Stage</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Localisation</mat-label>
          <input matInput formControlName="localisation" />
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Disponibilit√©</mat-label>
          <mat-select formControlName="disponibilite">
            <mat-option value="IMMEDIATE">Imm√©diate</mat-option>
            <mat-option value="UN_MOIS">1 mois</mat-option>
            <mat-option value="TROIS_MOIS">3 mois</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Pr√©tentions salariales</mat-label>
          <input matInput type="number" formControlName="pretentionsSalariales" />
        </mat-form-field>

        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Source</mat-label>
          <mat-select formControlName="source">
            <mat-option value="CANDIDATURE_DIRECT">Candidature directe</mat-option>
            <mat-option value="RECOMMANDATION">Recommandation</mat-option>
            <mat-option value="SITE_CARRIERE">Site carri√®re</mat-option>
            <mat-option value="LINKEDIN">LinkedIn</mat-option>
            <mat-option value="INDEED">Indeed</mat-option>
            <mat-option value="JOBBOOM">Jobboom</mat-option>
            <mat-option value="JOBILLICO">Jobillico</mat-option>
            <mat-option value="EMPLOI_QUEBEC">Emploi Qu√©bec</mat-option>
            <mat-option value="AUTRE">Autre</mat-option>
          </mat-select>
        </mat-form-field>

        <div style="text-align: right; margin-top: 8px;">
          <button mat-raised-button color="primary" type="submit" [disabled]="editMetadonneeRhForm.invalid">
            üíæ Enregistrer
          </button>
          <button mat-button type="button" (click)="toggleEditMetadonneeRh()">‚ùå Annuler</button>
        </div>
      </form>
    </mat-expansion-panel>
  </div>

  <!-- Section Recruteur / Employeur -->
<div *ngIf="isRecruteur || isEmployeur">

    <h3>üì¢ Mes offres publi√©es</h3>

    <mat-accordion *ngIf="user?.offres?.length">
      <mat-expansion-panel *ngFor="let o of user.offres">
        <mat-expansion-panel-header>
          <mat-panel-title>{{ o.titre }}</mat-panel-title>
          <mat-panel-description>{{ o.active ? '‚úÖ Active' : '‚ùå Inactive' }}</mat-panel-description>
        </mat-expansion-panel-header>
        <mat-list>
          <mat-list-item><strong>ID :</strong> {{ o.id || 'Non pr√©cis√©e' }}</mat-list-item>
          <mat-list-item><strong>Cat√©gorie :</strong> {{ o.categorie || 'Non pr√©cis√©e' }}</mat-list-item>
          <mat-list-item><strong>Ville :</strong> {{ o.ville || 'Non pr√©cis√©e' }}</mat-list-item>
          <mat-list-item><strong>Pays :</strong> {{ o.pays || 'Non pr√©cis√©' }}</mat-list-item>
          <mat-list-item><strong>Date de publication :</strong> {{ o.datePublication | date:'longDate'
            }}</mat-list-item>
          <mat-list-item>
            <strong>Fin d'affichage :</strong>
            {{ o.dateFinAffichage ? (o.dateFinAffichage | date:'longDate') : 'Non pr√©cis√©e' }}
          </mat-list-item>
          <mat-list-item><strong>Statut :</strong> {{ o.active ? 'Active' : 'Inactive' }}</mat-list-item>
        </mat-list>
        <div class="offre-description mt-2" *ngIf="o.description">
          <strong>Description :</strong>
          <div [innerHTML]="o.description"></div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>

    <p *ngIf="!user?.offres?.length">Aucune offre publi√©e pour le moment.</p>
  </div>

  <!-- Section ADMIN -->
  <div *ngIf="isAdmin">
    <mat-card class="mat-elevation-z2" style="text-align: left;">
      <h3>Administration</h3>
      <p>G√©rer les utilisateurs, les statistiques globales, etc.</p>
    </mat-card>


    <!-- Formulaire de cr√©ation de recruteur -->
    <mat-card class="mt-4">
      <mat-card-title>Cr√©er un compte Recruteur</mat-card-title>
      <mat-card-content [formGroup]="recruteurForm">
        <mat-form-field appearance="fill">
          <mat-label>Nom d'utilisateur</mat-label>
          <input matInput formControlName="username" required />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" required />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Mot de passe</mat-label>
          <input matInput type="password" formControlName="password" required />
        </mat-form-field>

        <button mat-flat-button color="primary" (click)="creerRecruteur()"
          [disabled]="recruteurForm.invalid || loading">
           <mat-icon style="color: white;">add</mat-icon>Cr√©er le recruteur
        </button>

        <mat-progress-bar *ngIf="loading" mode="indeterminate" class="mt-2"></mat-progress-bar>
      </mat-card-content>
    </mat-card>
  </div>
</div>